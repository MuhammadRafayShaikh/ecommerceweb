@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "My Profile";
}
@model E_Commerce.ViewModels.ProfileViewModel

<!-- Profile Page CSS -->
<link rel="stylesheet" href="~/user/profile/profile.css" asp-append-version="true">

<div class="profile-container">
    <!-- Header -->
    <div class="profile-header">
        <div class="header-content">
            <h1><i class="fas fa-user-circle"></i> My Profile</h1>
            <p class="header-subtitle">Manage your account settings and preferences</p>
        </div>
        <div class="header-actions">
            <a href="/" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
    {
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> @ViewBag.SuccessMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> @ViewBag.ErrorMessage
        </div>
    }

    <div class="profile-layout">
        <!-- Left Sidebar -->
        <div class="profile-sidebar">
            <!-- Profile Picture Section -->
            <div class="profile-picture-section">
                <div class="profile-avatar" id="profileAvatar">
                    <div class="avatar-initials">
                        @{
                            var initials = (!string.IsNullOrEmpty(Model.FirstName) ? Model.FirstName[0] : 'U').ToString() +
                            (!string.IsNullOrEmpty(Model.LastName) ? Model.LastName[0] : 's').ToString();
                        }
                        @initials
                    </div>
                    <div class="avatar-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <h3 class="profile-name">@Model.FirstName @Model.LastName</h3>
                <p class="profile-email">@Model.Email</p>

               
            </div>

            <!-- Navigation Menu -->
            <div class="profile-nav">
                <a href="#personal-info" class="nav-item active" data-section="personal-info">
                    <i class="fas fa-user"></i> Personal Info
                </a>
                <a href="#security" class="nav-item" data-section="security">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="#activity" class="nav-item" data-section="activity">
                    <i class="fas fa-chart-line"></i> Activity
                </a>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <h4><i class="fas fa-chart-bar"></i> Quick Stats</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="far fa-calendar"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="accountAge">0</span>
                            <span class="stat-label">Days on site</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="far fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value">
                                @(Model.EmailConfirmed ? "Verified" : "Pending")
                            </span>
                            <span class="stat-label">Email Status</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="profile-content">
            <!-- Personal Information Section -->
            <div class="profile-section active" id="personal-info-section">
                <div class="section-header">
                    <h2><i class="fas fa-user"></i> Personal Information</h2>
                    <a href="@Url.Action("Edit", "Profile")" class="btn-edit-section">
                        <i class="fas fa-edit"></i> Edit Profile
                    </a>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div class="info-content">
                            <h4>Full Name</h4>
                            <p>@Model.FirstName @Model.LastName</p>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="info-content">
                            <h4>Email Address</h4>
                            <p>@Model.Email</p>
                            @if (!Model.EmailConfirmed)
                            {
                                <a href="@Url.Action("ResendEmailVerification", "Profile")" class="verify-badge">
                                    <i class="fas fa-exclamation-triangle"></i> Verify Email
                                </a>
                            }
                            else
                            {
                                <span class="verified-badge">
                                    <i class="fas fa-check-circle"></i> Verified
                                </span>
                            }
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="info-content">
                            <h4>Phone Number</h4>
                            <p>@(string.IsNullOrEmpty(Model.PhoneNumber) ? "Not set" : Model.PhoneNumber)</p>
                            @if (!string.IsNullOrEmpty(Model.PhoneNumber) && Model.PhoneNumberConfirmed)
                            {
                                <span class="verified-badge">
                                    <i class="fas fa-check-circle"></i> Verified
                                </span>
                            }
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-user-tag"></i>
                        </div>
                        <div class="info-content">
                            <h4>Username</h4>
                            <p>@Model.UserName</p>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="far fa-calendar-plus"></i>
                        </div>
                        <div class="info-content">
                            <h4>Account Created</h4>
                            <p>@Model.CreatedAt.ToString("MMMM dd, yyyy")</p>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="far fa-calendar-check"></i>
                        </div>
                        <div class="info-content">
                            <h4>Last Updated</h4>
                            <p>@(Model.UpdatedAt?.ToString("MMMM dd, yyyy") ?? "Never")</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div class="profile-section" id="security-section">
                <div class="section-header">
                    <h2><i class="fas fa-shield-alt"></i> Security</h2>
                </div>

                <div class="security-grid">
                    <!-- Change Password Card -->
                    <div class="security-card">
                        <div class="security-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="security-content">
                            <h4>Change Password</h4>
                            <p>Update your password regularly to keep your account secure</p>
                            <button class="btn-change-password" onclick="openPasswordModal()">
                                <i class="fas fa-edit"></i> Change Password
                            </button>
                        </div>
                    </div>

                    <!-- Two-Factor Authentication Card -->
                    <div class="security-card">
                        <div class="security-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="security-content">
                            <h4>Two-Factor Authentication</h4>
                            <p>Add an extra layer of security to your account</p>
                            <div class="security-status">
                                <span class="status-badge disabled">
                                    <i class="fas fa-times-circle"></i> Disabled
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Login History Card -->
                    <div class="security-card">
                        <div class="security-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="security-content">
                            <h4>Login History</h4>
                            <p>View recent login activity on your account</p>
                            <button class="btn-view-logins" onclick="openLoginHistoryModal()">
                                <i class="fas fa-eye"></i> View History
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Section -->
            <div class="profile-section" id="activity-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line"></i> Activity</h2>
                    <button class="btn-refresh" onclick="loadActivity()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="activity-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-content">
                            <h4>Total Orders</h4>
                            <p class="stat-number">@ViewData["totalOrders"]</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-content">
                            <h4>Cart Items</h4>
                            <p class="stat-number">@ViewData["totalCarts"]</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h4>Reviews Written</h4>
                            <p class="stat-number">@ViewData["totalReviews"]</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h4>Last Login</h4>
                            <p class="stat-number" id="lastLoginTime">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="danger-zone">
                <div class="danger-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Danger Zone</h3>
                </div>
                <div class="danger-content">
                    <p>These actions are irreversible. Please proceed with caution.</p>
                    <div class="danger-actions">
                        <button class="btn-danger" onclick="openDeleteModal()">
                            <i class="fas fa-trash-alt"></i> Delete Account
                        </button>
                        @* <a href="@Url.Action("Logout", "Account")" class="btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a> *@
                        <form asp-controller="Account" asp-action="Logout" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn-logout">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-key"></i> Change Password</h2>
            <button class="close-modal" onclick="closePasswordModal()">&times;</button>
        </div>
        <form id="changePasswordForm" method="post" action="@Url.Action("ChangePassword", "Profile")">
            <input type="hidden" asp-for="Email"/>
            @Html.AntiForgeryToken()
            <div class="modal-body">
                <div class="form-group">
                    <label for="CurrentPassword">Current Password *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="CurrentPassword" name="CurrentPassword" required>
                        <button type="button" class="toggle-password" onclick="togglePassword('CurrentPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="NewPassword">New Password *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-key"></i>
                        <input type="password" id="NewPassword" name="NewPassword" required>
                        <button type="button" class="toggle-password" onclick="togglePassword('NewPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar"></div>
                        <span class="strength-text">Password strength: <span id="strengthText">Weak</span></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ConfirmPassword">Confirm New Password *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-key"></i>
                        <input type="password" id="ConfirmPassword" name="ConfirmPassword" required>
                        <button type="button" class="toggle-password" onclick="togglePassword('ConfirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="password-requirements">
                    <h4>Password Requirements:</h4>
                    <ul>
                        <li id="req-length">At least 6 characters</li>
                        <li id="req-uppercase">One uppercase letter</li>
                        <li id="req-lowercase">One lowercase letter</li>
                        <li id="req-number">One number</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closePasswordModal()">Cancel</button>
                <button type="submit" class="btn-save" disabled>Change Password</button>
            </div>
        </form>
    </div>
</div>

<!-- Login History Modal -->
<div id="loginHistoryModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-history"></i> Login History</h2>
            <button class="close-modal" onclick="closeLoginHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="login-history-container">
                <!-- Filter Controls -->
                <div class="history-filters">
                    <div class="filter-group">
                        <label for="historyPeriod">Period:</label>
                        <select id="historyPeriod" onchange="loadLoginHistory()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="historyStatus">Status:</label>
                        <select id="historyStatus" onchange="loadLoginHistory()">
                            <option value="all">All</option>
                            <option value="successful">Successful Only</option>
                            <option value="failed">Failed Only</option>
                        </select>
                    </div>
                    <button class="btn-refresh-history" onclick="loadLoginHistory()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Stats Summary -->
                <div class="history-stats">
                    <div class="history-stat">
                        <span class="stat-label">Total Logins:</span>
                        <span class="stat-value" id="totalLogins">0</span>
                    </div>
                    <div class="history-stat">
                        <span class="stat-label">Successful:</span>
                        <span class="stat-value" id="successfulLogins">0</span>
                    </div>
                    <div class="history-stat">
                        <span class="stat-label">Failed:</span>
                        <span class="stat-value" id="failedLogins">0</span>
                    </div>
                    <div class="history-stat">
                        <span class="stat-label">Last Login:</span>
                        <span class="stat-value" id="lastLogin">--</span>
                    </div>
                </div>

                <!-- Login History Table -->
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar"></i> Date & Time</th>
                                <th><i class="fas fa-laptop"></i> Device/Browser</th>
                                <th><i class="fas fa-map-marker-alt"></i> IP Address</th>
                                <th><i class="fas fa-check-circle"></i> Status</th>
                                <th><i class="fas fa-info-circle"></i> Details</th>
                            </tr>
                        </thead>
                        <tbody id="loginHistoryTable">
                            <!-- Data will be loaded here -->
                            <tr class="loading-row">
                                <td colspan="5">
                                    <div class="loading-spinner">
                                        <i class="fas fa-spinner fa-spin"></i> Loading login history...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="history-pagination" id="historyPagination">
                    <!-- Pagination will be loaded here -->
                </div>

                <!-- No Data Message -->
                <div class="no-data-message" id="noHistoryData" style="display: none;">
                    <div class="no-data-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <h3>No Login History Found</h3>
                    <p>You haven't logged in during the selected period.</p>
                </div>

                <!-- Export Options -->
                <div class="export-options">
                    <button class="btn-export" onclick="exportLoginHistory('csv')">
                        <i class="fas fa-file-csv"></i> Export as CSV
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-close" onclick="closeLoginHistoryModal()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header danger">
            <h2><i class="fas fa-exclamation-triangle"></i> Delete Account</h2>
            <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
        </div>
        <form id="deleteAccountForm" method="post" action="@Url.Action("DeleteAccount", "Profile")">
            @Html.AntiForgeryToken()
            <div class="modal-body">
                <div class="warning-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h3>Are you absolutely sure?</h3>
                <p>This action cannot be undone. This will permanently:</p>
                <ul class="delete-consequences">
                    <li>Deactivate your account</li>
                    <li>Remove your personal information from our database</li>
                    <li>Cancel any pending orders</li>
                    <li>Delete your wishlist and saved preferences</li>
                </ul>

                <div class="confirmation-box">
                    <label for="confirmText">
                        Please type <strong>DELETE</strong> to confirm:
                    </label>
                    <input type="text" id="confirmText" name="confirmText"
                           placeholder="Type DELETE here"
                           oninput="validateDeleteConfirmation()">
                    <div class="confirmation-error" id="confirmError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn-delete" disabled>Delete Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal-overlay">
    <div class="modal-content success-modal">
        <div class="modal-header success">
            <h2><i class="fas fa-check-circle"></i> Success!</h2>
            <button class="close-modal" onclick="closeSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3 id="successTitle">Operation Successful</h3>
            <p id="successMessage">Your changes have been saved successfully.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ok" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>
</div>
@await Html.PartialAsync("_Toast")
<script src="~/user/profile/profile.js"></script>